<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>实时看板</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_CN.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.0/chroma.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
    <script th:src="@{/static/js/main.js}" type="text/javascript"></script>
    <link rel="stylesheet" th:href="@{/static/css/main.css}">
</head>
<body>

<form th:action="@{/real/search}" th:object="${param}" method="post">
    <label for="stockPoolId">
        <span>股票池ID：</span>
        <select id="stockPoolId" th:field="*{stockPoolId}">
            <option th:each="item: ${pools}" th:value="${item.id}" th:text="${item.poolName}"></option>
        </select>
    </label>
    <label for="offset">偏移天数：</label>
    <input type="text" th:field="*{offset}" id="offset" placeholder="偏移天数" style="width: 80px">
    <label for="pl">短期：</label>
    <input type="text" th:field="*{pl}" id="pl" placeholder="短期" style="width: 80px">
    <label for="xl">中期：</label>
    <input type="text" th:field="*{xl}" id="xl" placeholder="中期" style="width: 80px">
    <label for="yl">长期：</label>
    <input type="text" th:field="*{yl}" id="yl" placeholder="长期" style="width: 80px">
    <input type="submit" value="查询">
    <div id="labelButton" class="btn">标签</div>
</form>

<div style="display: flex">
    <div th:if="${nodes}" style="float: left">
        <table>
            <tr>
                <th>No.</th>
                <th>股票代码</th>
                <th>股票名称</th>
                <th>短期</th>
                <th>中期</th>
                <th>长期</th>
                <th>简图</th>
            </tr>
            <tr th:each="item,iter: ${nodes}">
                <td th:text="${iter.index}"></td>
                <td>
                    <a th:text="${item.code}" th:href="@{'/app/history/' + ${item.code}}" target="_blank"></a>
                </td>
                <td th:text="${item.name}"></td>
                <td th:id="'pp'+${iter.index}" style="text-align: right; font-weight: normal; color: azure">
                    <span th:text="${#numbers.formatDecimal(item.dpPercent, 1, 'COMMA', 2, 'POINT')}"></span>
                    <span>%</span>
                </td>
                <td th:id="'xp'+${iter.index}" style="text-align: right; font-weight: normal; color: azure">
                    <span th:text="${#numbers.formatDecimal(item.dxPercent, 1, 'COMMA', 2, 'POINT')}"></span>
                    <span>%</span>
                </td>
                <td th:id="'yp'+${iter.index}" style="text-align: right; font-weight: normal; color: azure">
                    <span th:text="${#numbers.formatDecimal(item.dyPercent, 1, 'COMMA', 2, 'POINT')}"></span>
                    <span>%</span>
                </td>
                <td>
                    <div th:id="'KLineChart'+${iter.index}" style="width: 200px;height:30px;"></div>
                    <script th:inline="javascript">
                        function getColor(value) {
                            return chroma.scale([chroma("#ff0000"), chroma("#00ff00")]).domain([-40, 40])(value).hex();
                        }

                        document.getElementById('pp' + [[${iter.index}]]).style.backgroundColor = getColor([[${item.dpPercent}]]);
                        document.getElementById('xp' + [[${iter.index}]]).style.backgroundColor = getColor([[${item.dxPercent}]]);
                        document.getElementById('yp' + [[${iter.index}]]).style.backgroundColor = getColor([[${item.dyPercent}]]);
                        echarts.init(document.getElementById('KLineChart' + [[${iter.index}]])).setOption({
                            xAxis: {
                                show: false,
                                type: 'category',
                            },
                            yAxis: {
                                show: false,
                                type: 'value',
                                max: [[${item.maxPrice}]],
                                min: [[${item.minPrice}]],
                            },
                            grid: {
                                top: 0,
                                bottom: 0,
                                left: 0,
                                right: 0,
                            },
                            visualMap: {
                                type: 'piecewise',
                                show: false,
                                dimension: 0,
                                seriesIndex: 0,
                                pieces: [
                                    {
                                        gt: 0,
                                        lt: [[${item.closeArr}]].length - [[${item.yl}]],
                                        color: 'gray'
                                    },
                                    {
                                        gt: [[${item.closeArr}]].length - [[${item.yl}]],
                                        color: 'rgba(9,116,203,0.82)'
                                    }
                                ]
                            },
                            series: [
                                {
                                    data: [[${item.closeArr}]],
                                    type: 'line',
                                    symbol: 'none',
                                    itemStyle: {
                                        color: 'black'
                                    },
                                    lineStyle: {
                                        width: 1
                                    },
                                    markPoint: {
                                        data: [
                                            {
                                                type: 'max',
                                                itemStyle: {
                                                    color: '#00ff00',
                                                },
                                                symbol: 'circle',
                                                symbolSize: 4,
                                                label: {
                                                    show: false,
                                                }
                                            }, {
                                                type: 'min',
                                                itemStyle: {
                                                    color: '#ff0000',
                                                },
                                                symbol: 'circle',
                                                symbolSize: 4,
                                                label: {
                                                    show: false,
                                                }
                                            },
                                        ]
                                    }
                                }
                            ]
                        });
                    </script>
                </td>
            </tr>
        </table>
    </div>
    <div th:if="${nodes}" style="float: left">
        <div id="klineChart" style="width: 1600px; height: 1100px"></div>
        <script th:inline="javascript">
            function getTipColor(value) {
                return chroma.scale([chroma("#ff0000"), chroma("gray"), chroma("#00ff00")]).domain([-20, 20])(value).hex();
            }

            const data = [[${nodes}]].map(item => [item['dxPercent'], item['dyPercent'], item['dpPercent'], item['name'], item['code']]);
            console.log([[${nodes}]])
            option = {
                grid: {
                    left: '8%',
                },
                tooltip: {
                    formatter: function (params) {
                        return `${params.marker} ${params.data[3]}</br><table>`
                            + `<tr><td>短期</td><td style="background-color: ${getTipColor(params.data[2])}; text-align: right; color: aliceblue">${params.data[2].toFixed(2)}%</td></tr>`
                            + `<tr><td>中期</td><td style="background-color: ${getTipColor(params.data[0])}; text-align: right; color: aliceblue">${params.data[0].toFixed(2)}%</div></tr>`
                            + `<tr><td>长期</td><td style="background-color: ${getTipColor(params.data[1])}; text-align: right; color: aliceblue">${params.data[1].toFixed(2)}%</td></tr>`
                            + `</table>`
                    }
                },
                xAxis: {
                    boundaryGap: false,
                    splitLine: {show: false},
                    axisLine: {
                        onZero: true,
                        lineStyle: {
                            type: 'dashed'
                        }
                    },
                    axisLabel: {
                        formatter: function (value) {
                            return value + '%';
                        }
                    }
                },
                yAxis: {
                    axisLine: {
                        onZero: true,
                        lineStyle: {
                            type: 'dashed'
                        }
                    },
                    axisTick: {show: false},
                    splitLine: {show: false},
                    scale: true,
                    axisLabel: {
                        formatter: function (value) {
                            return value + '%';
                        }
                    }
                },
                visualMap: {
                    show: false,
                    min: -10,
                    max: 10,
                    dimension: 2,
                    inRange: {
                        color: ['red', 'gray', 'green']
                    }
                },
                series: [
                    {
                        data: data,
                        type: 'scatter',
                        symbolSize: function (data) {
                            return Math.min(Math.max(Math.abs(data[2]) * 5, 6), 50);
                        },
                        label: {
                            show: true,
                            formatter: function (param) {
                                return param.data[3] + ' ' + param.data[2].toFixed(2) + '%';
                            },
                            position: 'top',
                            fontSize: 10,
                            color: '#fff'
                        },
                        emphasis: {
                            label: {
                                show: true
                            }
                        }
                    }
                ]
            };

            if (data.length > 20) {
                option.series[0].label.show = false
            }

            const myChart = echarts.init(document.getElementById('klineChart'));
            myChart.setOption(option);

            $('#labelButton').on('click', function() {
                option.series[0].label.show = !option.series[0].label.show; // 确保访问的是 option.series
                myChart.setOption(option); // 强制使用新的配置项重绘图表
            });
        </script>
    </div>
</div>
</body>
</html>